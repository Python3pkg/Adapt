{"name":"Adapt","tagline":"Linux USB JTAG controller for Digilent boards.","body":"### Protocol documentation for Digilent USB JTAG controllers.\r\nThe following describes all understood messages in the Digilent's USB protocol for communicating with fpgas over JTAG on their development boards.\r\n\r\nThere are two main types of messages sent over USB: *Control* and *Bulk*.\r\n\r\n####Control Messages\r\nThese messages have nothing to do with JTAG and are all about reading data about the board/JTAG controller, or writing JTAG controller settings. None of the known messages of this type cause activity on JTAG pins connected to the target device. All of these messages are sent to USB endpoint **0**, and result in either data being sent to the device (OUT) or read from the device (IN). \r\n\r\nFor those unfamiliar with how USB control messages are sent, there are 3 parameters every message transaction needs in addition to **direction**: **Request Code**, **Value**, and **Length**. **Request** code is the most obvious and can be considered the function being called. **Value** can be thought of as the parameter to the request. **length** is the number of bytes that will be sent to or received from the device depending on the direction of the transfer. Usually a given message has a known **length** for a **Request Code** so it is not hard to get these right.\r\n\r\n|Name|RQ*|Direction|Value|Length|Description|\r\n|----|---|---------|-----|------|-----------|\r\n| UNKNOWN | A0 |OUT| ? | ? |Commands seem to be some sort of control register write. Not used in the init of spartan 3 or Coolrunner 2.|\r\n| Product Name | E1 |IN | 0 | 28 | ASCII| \r\n| User Name | E2 |IN | 0 | 16 | ASCII |\r\n| Serial Number | E4 |IN | 0 | 12 | ASCII |\r\n| Firmware Version | E6 |IN | 0 | 2 | RAW BYTES Little Endian. |\r\n| UNKNOWN STATUS (MAC?) | E7 |IN | 0 | 8 | Seems to be some sort of status register effected by calls to A0 Value usually 0->xx:00:00:00:00:00:00:00. For the Basys2 board, the 64 bit values are | together. Define port properties bits for JTAG ports.??? djtg.h? |\r\n| Set OEM Seed | E8 |OUT| 0 | 2 | Sends random seed, or 14 if can't get uptime as source. EC is usually called after. After EC seed is set to 00. |\r\n| Product ID | E9 |IN | 0 | 4 | Reversed byte order for some reason RAW BYTES. Digilent adapter cables have BigE 000000xx. In normal cases, this last byte being between 0x20 and 0x40 has special meaning of some kind.  |\r\n| OEM ID CHECK | EC |IN | 0 | 4 | Takes value passed in from E8 and xors the bytes plus other stuff still researching. ??:??:??:yx where xy = e8(hi)^e8(lo). The four bytes spell Digi when xored with the xor of the bytes passed to E8. REVERSED so technically igiD. It also seems to support (these values return reversed) 0x356A92C7 and 0x586F656D. |\r\n\r\n######(RQ is Request Code)\r\n\r\n\r\n####Bulk Messages\r\nMost of the bulk messages get JTAG related details from the board. Some of them still only read details about the controller chip, but the really interesting commands require JTAG being enabled first.\r\n\r\nAll messages that start these bulk transaction are sent to the same USB endpoint (1) and have this basic structure:\r\n\r\nSZ:CT:RQ:00:{Parameters to the request if any}\r\n\r\nSZ: The length of the message in bytes not including this length byte. (One less than the total length of the data returned).\r\n\r\nCT: Category or request. Almost always 0x02.\r\n\r\nRQ: Request Code\r\n\r\n\r\n\r\n#####Status Response message format:\r\n\r\nBULK IN (USB ENDPOINT 2) 01:XX #Status code. 1 byte long. 00 known to be 'good'. 03 is a fail of some kind (when the device is already in use).\r\n\r\n#####Bulk request types.\r\n\r\nAll of the known bulk messages are similar, but among them, there are two primary types based on how the controller responds.\r\n\r\n* **Bulk Configuration Request:** Requests that return a single message. These messages may be either a status code in the case of a command, or the raw data if querying a value. They all start with the same length byte as above.\r\n* **Bulk JTAG Control Request:** The responses to these messages are much more complex and involve 4 or 5 messages .\r\n\r\n#####AVD Response protocol (Note the variables here refer to labels below the next chart):\r\n\r\n1. Initialization message (In table below).\r\n2. Status Code message (described above).\r\n3. YY* Raw bit data rounded to the byte. XX bits. USB Endpoint 3.\r\n4. YY* Raw bit data rounded to the byte. XX bits. USB Endpoint 4. Only sent if RV in init message is 1.\r\n5. 03:02:ZZ:00 to USB Endpoint 1. ZZ = 80|RQ. RQ is the RQ of the init message. Requests number of bits transferred.\r\n6. This is too much of a pain to do at 4 AM.\r\n\r\n\r\n#####Bulk JTAG Control Request Commands:\r\n\r\n|Name|CT|RQ|Transaction Type|SZ|Parameters|\r\n|----|----|----|----------------|----|----|\r\n| ENABLE JTAG         | 02 | 00 | Simple | 3 | None |\r\n| DISABLE JTAG        | 02 | 01 | Simple | 4 | None |\r\n| PORT INFO           | 02 | 02 | Simple | 4 | 1 byte detail type. **0x01:** Port Count. **0x05:** Port Properties. |\r\n| SET SPEED           | 02 | 03 | Simple | 7 | 4 byte speed in bps |\r\n| GET SPEED           | 02 | 04 | Simple | 3 | None |\r\n| SET Tms Tdi Tdo     | 02 | 05 | Simple | 6 | MS:DI:DO One byte each. |\r\n| GET Tms Tdi Tdo Tck | 02 | 06 | Simple | 3 | None |\r\n| WRITE TDI BITS      | 02 | 08 | ADV    | 9 | RV:MS:XX:XX:XX:XX (Check) |\r\n| READ TDO BITS       | 02 | 09 | ADV    | 9 | MS:DI:XX:XX:XX:XX         |\r\n| WRITE TMS/TDI BITS  | 02 | 10 | ADV    | 8 | RV:XX:XX:XX:XX            |\r\n| WRITE TMS BITS      | 02 | 11 | ADV    | 9 | RV:DI:XX:XX:XX:XX (Check) |\r\n\r\n######(XX is the number of bits to transfer. Little Endian Number. 4 bytes.)\r\n######(MS, DI, DO, and CK are Boolean values for the state of the pins TMS, TDI, TDO, and TCK respectively. )\r\n######(RV is 1 if the values shifted out of TDO should be returned. This causes an additional packet to be sent from the device after the transfer of the provided input data.)","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}